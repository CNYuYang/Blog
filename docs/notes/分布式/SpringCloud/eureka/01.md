# Spring Cloud Netflix æ³¨å†Œä¸­å¿ƒ Eureka å…¥é—¨

## æ¦‚è¿°

æœ¬æ–‡æˆ‘ä»¬æ¥å­¦ä¹  [Spring Cloud Netflix](https://github.com/spring-cloud/spring-cloud-netflix) æä¾›çš„ [`spring-cloud-netflix-eureka-server`](https://github.com/spring-cloud/spring-cloud-netflix/blob/2.2.x/spring-cloud-netflix-eureka-server/) å’Œ [`spring-cloud-netflix-eureka-server`](https://github.com/spring-cloud/spring-cloud-netflix/blob/2.2.x/spring-cloud-netflix-eureka-client/) ç»„ä»¶ï¼ŒåŸºäº Spring Cloud çš„ç¼–ç¨‹æ¨¡å‹ï¼Œæ¥å…¥ [Eureka](https://github.com/Netflix/eureka) ä½œä¸ºæ³¨å†Œä¸­å¿ƒï¼Œå®ç°æœåŠ¡çš„æ³¨å†Œä¸å‘ç°ã€‚

> æ—ç™½å›ï¼šä¸‹é¢æˆ‘ä»¬å…ˆæ¥ç§‘æ™® Eureka å’Œæ³¨å†Œä¸­å¿ƒçš„æ¦‚å¿µï¼Œä¿æŒè€å¿ƒï¼Œå˜¿å˜¿~

##  Eureka ç®€ä»‹

Eureka æ˜¯ Netflix å¼€æºçš„**æ³¨å†Œä¸­å¿ƒ**ç»„ä»¶ï¼Œåˆ†æˆ Eureka **Client** å’Œ Eureka **Server** ä¸¤ä¸ªè§’è‰²ã€‚æ•´ä½“æ¶æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](./img/01-01.png)

- **Eureka-Server** ï¼šé€šè¿‡ REST åè®®æš´éœ²æœåŠ¡ï¼Œæä¾›åº”ç”¨æœåŠ¡çš„æ³¨å†Œå’Œå‘ç°çš„åŠŸèƒ½ã€‚
- **Application Server** ï¼šåº”ç”¨æœåŠ¡**æä¾›è€…**ï¼Œå†…åµŒ **Eureka-Client** ï¼Œé€šè¿‡å®ƒå‘**Eureka-Server** æ³¨å†Œè‡ªèº«æœåŠ¡ã€‚
- **Application Client** ï¼šåº”ç”¨æœåŠ¡**æ¶ˆè´¹è€…**ï¼Œå†…åµŒ **Eureka-Client** ï¼Œé€šè¿‡å®ƒä» **Eureka-Server** è·å–æœåŠ¡åˆ—è¡¨ã€‚

> å‹æƒ…æç¤ºï¼šè¯·æ³¨æ„ä¸‹ï¼Œ**Application Server** å’Œ **Application Client** å¼ºè°ƒæ‰®æ¼”çš„è§’è‰²ï¼Œå®é™…å¯ä»¥åœ¨åŒä¸€ JVM è¿›ç¨‹ï¼Œå³æ˜¯æœåŠ¡çš„æä¾›è€…ï¼Œåˆæ˜¯æœåŠ¡çš„æ¶ˆè´¹è€…ã€‚

ğŸ”¥ æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹æœåŠ¡å’Œ Eureka ä¹‹é—´çš„äº¤äº’è¡Œä¸ºï¼š

**â‘  Registerï¼ˆæ³¨å†Œï¼‰**

æœåŠ¡**æä¾›æ–¹**ä½¿ç”¨ **Eureka-Client** æ³¨å†Œè‡ªå·±åˆ° **Eureka-Server** ä¸Šï¼Œæ·»åŠ åˆ°æ³¨å†Œè¡¨ï¼Œæˆä¸º**æœåŠ¡**çš„ä¸€ä¸ª**å®ä¾‹**ã€‚


æœåŠ¡**æä¾›æ–¹**ä½¿ç”¨ **Eureka-Client** æ¯ 30 ç§’å‘ **Eureka-Server** å‘èµ·ä¸€æ¬¡å¿ƒè·³ï¼Œå‘Šè¯‰ **Eureka-Server** å½“å‰æœåŠ¡**å®ä¾‹**è¿˜**å­˜æ´»**ã€‚

å¦‚æœ **Eureka-Server** 90 ç§’æ²¡æœ‰æ”¶åˆ° **Eureka-Client** çš„å¿ƒè·³ï¼Œä¼šè®¤ä¸ºå®ƒå·²ç»**ä¸‹çº¿**ï¼Œå°†è¯¥æœåŠ¡**å®ä¾‹**ä»æ³¨å†Œè¡¨ç§»é™¤ã€‚

**ä¸ºä»€ä¹ˆ**éœ€è¦å¿ƒè·³ï¼ŸEureka é‡‡ç”¨ REST **çŸ­**è¿æ¥ï¼Œè€Œé TCP **é•¿**è¿æ¥ï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡å¿ƒè·³æœºåˆ¶æ¥ç¡®è®¤**æ˜¯å¦å­˜æ´»**ã€‚

**â‘¢ Get Registryï¼ˆè·å–æ³¨å†Œä¿¡æ¯ï¼‰**

æœåŠ¡**æ¶ˆè´¹è€…**ä½¿ç”¨ **Eureka-Client** ä» **Eureka-Server** è·å–**å…¨é‡**æ³¨å†Œè¡¨ï¼Œå¹¶ç¼“å­˜åœ¨**æœ¬åœ°å†…å­˜**ã€‚ä¹‹åï¼ŒæœåŠ¡**æ¶ˆè´¹è€…**è¦è¿œç¨‹è°ƒç”¨æœåŠ¡**æä¾›è€…**æ—¶ï¼Œåªéœ€è¦ä»æœ¬åœ°ç¼“å­˜çš„æ³¨å†Œè¡¨æŸ¥æ‰¾å¯¹åº”çš„æœåŠ¡å³å¯ã€‚

è€ƒè™‘åˆ° **Eureka-Server** çš„æ³¨å†Œè¡¨æ˜¯ä¸æ–­å˜åŒ–çš„ï¼ŒæœåŠ¡**æ¶ˆè´¹è€…**æ¯ 30 ç§’ä½¿ç”¨ **Eureka-Client** ä» **Eureka-Server** è·å–**å¢é‡**å˜åŒ–çš„éƒ¨åˆ†ï¼Œ**åˆå¹¶**æ›´æ–°åˆ°æœ¬åœ°ç¼“å­˜çš„æ³¨å†Œè¡¨ã€‚

**â‘£ Cancelï¼ˆä¸‹çº¿ï¼‰**

æœåŠ¡**æä¾›è€…**å‡†å¤‡ä¸‹çº¿æ—¶ï¼Œä½¿ç”¨ **Eureka-Client** å‘ **Eureka-Server** å‘èµ·å–æ¶ˆæ³¨å†Œè¯·æ±‚ï¼Œä»è€Œä»æ³¨å†Œè¡¨ä¸­ç§»é™¤ï¼Œé¿å…åç»­æœåŠ¡**æ¶ˆè´¹è€…**è¯·æ±‚å½“å‰å®ä¾‹ã€‚

ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬æŠŠè¿™ç§æ–¹å¼ç§°ä¸ºâ€œæ­£å¸¸ä¸‹çº¿â€ã€‚ä¸ä¹‹ç›¸å¯¹çš„ï¼Œå°±æ˜¯å¿ƒè·³è¶…æ—¶å¯¼è‡´çš„â€œå¼‚å¸¸ä¸‹çº¿â€ã€‚

ğŸ”¥ æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ Eureka-Server ä¹‹é—´çš„äº¤äº’è¡Œä¸ºï¼š

Eureka-Server åœ¨ [CAP å®šç†](https://zh.wikipedia.org/wiki/CAPå®šç†) ä¸­ï¼Œé€‰æ‹©äº† **AP** æ¥å®ç°ï¼š

- ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ï¼šç­‰åŒäºæ‰€æœ‰èŠ‚ç‚¹è®¿é—®åŒä¸€ä»½æœ€æ–°çš„æ•°æ®å‰¯æœ¬ã€‚
- å¯ç”¨æ€§ï¼ˆAvailabilityï¼‰ï¼šæ¯æ¬¡è¯·æ±‚éƒ½èƒ½è·å–åˆ°**éé”™**çš„å“åº”ï¼Œä½†æ˜¯**ä¸**ä¿è¯è·å–çš„æ•°æ®ä¸º**æœ€æ–°**æ•°æ®ã€‚

## æ³¨å†Œä¸­å¿ƒåŸç†

æœ¬å°èŠ‚ï¼Œæˆ‘ä»¬å†æ¥å•°å—¦ä¸‹é€šç”¨çš„æ³¨å†Œä¸­å¿ƒåŸç†ã€‚

åœ¨ä½¿ç”¨æ³¨å†Œä¸­å¿ƒæ—¶ï¼Œä¸€å…±æœ‰ä¸‰ç§è§’è‰²ï¼šæœåŠ¡æä¾›è€…ï¼ˆService Providerï¼‰ã€æœåŠ¡æ¶ˆè´¹è€…ï¼ˆService Consumerï¼‰ã€æ³¨å†Œä¸­å¿ƒï¼ˆRegistryï¼‰ã€‚

> åœ¨ä¸€äº›æ–‡ç« ä¸­ï¼ŒæœåŠ¡æä¾›è€…è¢«ç§°ä¸º Serverï¼ŒæœåŠ¡æ¶ˆè´¹è€…è¢«ç§°ä¸º Clientã€‚èƒ–å‹ä»¬çŸ¥é“å³å¯ã€‚

ä¸‰ä¸ªè§’è‰²äº¤äº’å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](./img/01-02.png)

â‘  Providerï¼š

- å¯åŠ¨æ—¶ï¼Œå‘ Registry **æ³¨å†Œ**è‡ªå·±ä¸ºä¸€ä¸ªæœåŠ¡ï¼ˆServiceï¼‰çš„å®ä¾‹ï¼ˆInstanceï¼‰ã€‚
- åŒæ—¶ï¼Œå®šæœŸå‘ Registry å‘é€**å¿ƒè·³**ï¼Œå‘Šè¯‰è‡ªå·±è¿˜å­˜æ´»ã€‚
- å…³é—­æ—¶ï¼Œå‘ Registry **å–æ¶ˆæ³¨å†Œ**ã€‚

â‘¡ Consumerï¼š

- å¯åŠ¨æ—¶ï¼Œå‘ Registry **è®¢é˜…**ä½¿ç”¨åˆ°çš„æœåŠ¡ï¼Œå¹¶ç¼“å­˜æœåŠ¡çš„å®ä¾‹åˆ—è¡¨åœ¨å†…å­˜ä¸­ã€‚
- åç»­ï¼ŒConsumer å‘å¯¹åº”æœåŠ¡çš„ Provider å‘èµ·**è°ƒç”¨**æ—¶ï¼Œä»å†…å­˜ä¸­çš„è¯¥æœåŠ¡çš„å®ä¾‹åˆ—è¡¨é€‰æ‹©ä¸€ä¸ªï¼Œè¿›è¡Œè¿œç¨‹è°ƒç”¨ã€‚
- å…³é—­æ—¶ï¼Œå‘ Registry **å–æ¶ˆè®¢é˜…**ã€‚

â‘¢ Registryï¼š

- Provider è¶…è¿‡ä¸€å®šæ—¶é—´æœª**å¿ƒè·³**æ—¶ï¼Œä»æœåŠ¡çš„å®ä¾‹åˆ—è¡¨ç§»é™¤ã€‚
- æœåŠ¡çš„å®ä¾‹åˆ—è¡¨å‘ç”Ÿå˜åŒ–ï¼ˆæ–°å¢æˆ–è€…ç§»é™¤ï¼‰æ—¶ï¼Œé€šçŸ¥è®¢é˜…è¯¥æœåŠ¡çš„ Consumerï¼Œä»è€Œè®© Consumer èƒ½å¤Ÿåˆ·æ–°æœ¬åœ°ç¼“å­˜ã€‚

å½“ç„¶ï¼Œä¸åŒçš„æ³¨å†Œä¸­å¿ƒå¯èƒ½åœ¨å®ç°åŸç†ä¸Šä¼šç•¥æœ‰å·®å¼‚ã€‚ä¾‹å¦‚è¯´ï¼Œ[Eureka](https://github.com/Netflix/eureka/) æ³¨å†Œä¸­å¿ƒï¼Œå¹¶ä¸æä¾›é€šçŸ¥åŠŸèƒ½ï¼Œè€Œæ˜¯ Eureka Client è‡ªå·±å®šæœŸè½®è¯¢ï¼Œå®ç°æœ¬åœ°ç¼“å­˜çš„æ›´æ–°ã€‚

å¦å¤–ï¼ŒProvider å’Œ Consumer æ˜¯è§’è‰²ä¸Šçš„å®šä¹‰ï¼Œä¸€ä¸ªæœåŠ¡**åŒæ—¶**å³å¯ä»¥æ˜¯ Provider ä¹Ÿå¯ä»¥ä½œä¸º Consumerã€‚ä¾‹å¦‚è¯´ï¼Œä¼˜æƒ åŠµæœåŠ¡å¯ä»¥ç»™è®¢å•æœåŠ¡æä¾›æ¥å£ï¼ŒåŒæ—¶åˆè°ƒç”¨ç”¨æˆ·æœåŠ¡æä¾›çš„æ¥å£ã€‚

## å¿«é€Ÿå…¥é—¨

æœ¬å°èŠ‚ï¼Œæˆ‘ä»¬æ¥æ­å»ºä¸€ä¸ª Eureka ç»„ä»¶çš„å¿«é€Ÿå…¥é—¨ç¤ºä¾‹ã€‚æ­¥éª¤å¦‚ä¸‹ï¼š

- é¦–å…ˆï¼Œä½¿ç”¨ `spring-cloud-netflix-eureka-server` ä¾èµ–ï¼Œæ¥æ­å»ºä¸€ä¸ª Eureka **æ³¨å†Œä¸­å¿ƒ**ã€‚
- ç„¶åï¼Œæ­å»ºä¸€ä¸ª**æœåŠ¡æä¾›è€…** `demo-provider`ï¼Œæ³¨å†ŒæœåŠ¡åˆ° Eureka ä¸­ã€‚
- æœ€åï¼Œæ­å»ºä¸€ä¸ª**æœåŠ¡æ¶ˆè´¹è€…** `demo-consumer`ï¼Œä» Eureka è·å–åˆ° `demo-provider` æœåŠ¡çš„å®ä¾‹åˆ—è¡¨ï¼Œé€‰æ‹©å…¶ä¸­ä¸€ä¸ªç¤ºä¾‹ï¼Œè¿›è¡Œ HTTP è¿œç¨‹è°ƒç”¨ã€‚

### æ­å»º Eureka æ³¨å†Œä¸­å¿ƒ

åˆ›å»º [`labx-22-scn-eureka-server-standalone`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/labx-22/labx-22-scn-eureka-server-standalone) é¡¹ç›®ï¼Œä½œä¸º Eureka æ³¨å†Œä¸­å¿ƒã€‚æœ€ç»ˆé¡¹ç›®ä»£ç å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](./img/01-03.png)

#### å¼•å…¥ä¾èµ–

åˆ›å»º `pom.xml` æ–‡ä»¶ï¼Œä¸»è¦å¼•å…¥ **Spring Cloud Netflix Eureka Server** ç›¸å…³ä¾èµ–ã€‚ä»£ç å¦‚ä¸‹ï¼š

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-netflix-eureka-server</artifactId>
    <version>2.2.0.RELEASE</version>
</dependency>
```

é€šè¿‡ `spring-cloud-starter-netflix-eureka-server`åŒ…ï¼Œå¼•å…¥ Spring Cloud Netflix Eureka Server ç›¸å…³ä¾èµ–ï¼Œå°† Eureka ä½œä¸ºæ³¨å†Œä¸­å¿ƒçš„æœåŠ¡å™¨ï¼Œå¹¶å®ç°å¯¹å…¶çš„è‡ªåŠ¨é…ç½®ã€‚

#### é…ç½®æ–‡ä»¶

åˆ›å»º `application.yaml` é…ç½®æ–‡ä»¶ï¼Œä¸»è¦æ·»åŠ  Eureka ç›¸å…³é…ç½®é¡¹ã€‚é…ç½®å¦‚ä¸‹ï¼š

```yaml
server:
  port: 8761 # è®¾ç½® Eureka-Server çš„ç«¯å£

spring:
  application:
    name: eureka-server

eureka:
  client:
    register-with-eureka: false # ä¸æ³¨å†Œåˆ° Eureka-Serverï¼Œé»˜è®¤ä¸º true
    fetch-registry: false # ä¸ä» Eureka-Server è·å–æ³¨å†Œè¡¨ï¼Œé»˜è®¤ä¸º true
```

â‘  `server.port` é…ç½®é¡¹ï¼Œè®¾ç½®å¯åŠ¨çš„ Eureka-Server çš„ç«¯å£ã€‚

â‘¡ `eureka.client` é…ç½®é¡¹ï¼Œè®¾ç½® Eureka-Client é…ç½®é¡¹ï¼Œå¯¹åº” `EurekaClientConfigBean`é…ç½®ç±»ã€‚

Eureka-Server ä¼šå¯åŠ¨ä¸€ä¸ª Eureka-Client å®¢æˆ·ç«¯ï¼Œç”¨äº Eureka-Server **é›†ç¾¤**ä¹‹é—´çš„è¯·æ±‚äº¤äº’ï¼Œå› ä¸ºè¿™é‡Œæˆ‘ä»¬ä»…ä»…æ­å»º Eureka-Server **å•èŠ‚ç‚¹**ï¼Œæ‰€ä»¥è®¾ç½® `register-with-eureka` å’Œ `fetch-registry` é…ç½®é¡¹ä¸º `false`ï¼Œæ— éœ€ç›¸äº’æ³¨å†Œã€‚

#### EurekaServerApplication

åˆ›å»º `EurekaServerApplication`ç±»ï¼ŒEureka æ³¨å†Œä¸­å¿ƒçš„å¯åŠ¨ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

```java
@SpringBootApplication
@EnableEurekaServer
public class EurekaServerApplication {

    public static void main(String[] args) {
        SpringApplication.run(EurekaServerApplication.class,args);
    }

}
```

åœ¨ç±»ä¸Šæ·»åŠ  `@EnableEurekaServer`æ³¨è§£ï¼Œå£°æ˜å¯åŠ¨ Eureka-Server æœåŠ¡ã€‚

### æ­å»ºæœåŠ¡æä¾›è€…

![](./img/01-04.png)

åˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®ï¼Œä½œä¸ºæœåŠ¡æä¾›è€… `demo-provider`ã€‚æœ€ç»ˆé¡¹ç›®ä»£ç å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

#### å¼•å…¥ä¾èµ–

åˆ›å»º `pom.xml` æ–‡ä»¶ï¼Œä¸»è¦å¼•å…¥ **Spring Cloud Netflix Eureka Client** ç›¸å…³ä¾èµ–ã€‚ä»£ç å¦‚ä¸‹ï¼š

```xml
<dependencies>
    <!-- https://mvnrepository.com/artifact/org.springframework.cloud/spring-cloud-starter-netflix-eureka-client -->
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
        <version>2.2.4.RELEASE</version>
    </dependency>
</dependencies>
```

#### é…ç½®æ–‡ä»¶

åˆ›å»º `application.yaml`é…ç½®æ–‡ä»¶ï¼Œä¸»è¦æ·»åŠ  Eureka ç›¸å…³é…ç½®é¡¹ã€‚é…ç½®å¦‚ä¸‹ï¼š

```java
spring:
  application:
    name: demo-provider # Spring åº”ç”¨å

server:
  port: 18080 # æœåŠ¡å™¨ç«¯å£ã€‚é»˜è®¤ä¸º 8080

eureka:
  client:
    register-with-eureka: true # æ³¨å†Œåˆ° Eureka-Serverï¼Œé»˜è®¤ä¸º true
    fetch-registry: true # ä» Eureka-Server è·å–æ³¨å†Œè¡¨ï¼Œé»˜è®¤ä¸º true
    service-url:
      defaultZone: http://127.0.0.1:8761/eureka/ # Eureka-Server åœ°å€
```

â‘  è®¾ç½® `eureka.client.register-with-eureka` ä¸º `true`ï¼Œæ³¨å†Œå½“å‰æœåŠ¡åˆ° Eureka-Server æ³¨å†Œä¸­å¿ƒä¸­ã€‚

â‘¡ è®¾ç½® `eureka.client.fetch-registry` ä¸º `true`ï¼Œä» Eureka-Server æ³¨å†Œä¸­å¿ƒæ‹‰å–æ³¨å†Œè¡¨ã€‚å®é™…ä¸Šï¼Œè¿™é‡Œå¯ä»¥è®¾ç½® `false`ï¼Œå› ä¸ºåœ¨å®ä¾‹ä¸­ä»…ä»…æ‰®æ¼”æœåŠ¡**æä¾›è€…**çš„è§’è‰²ã€‚

â‘¢ `eureka.client.service-url` é…ç½®é¡¹ï¼Œè®¾ç½®è¿æ¥çš„ Eureka-Server åœ°å€ã€‚Eureka æ˜¯æœ‰å¤š Zone åŒºåŸŸçš„æ¦‚å¿µï¼Œä¸è¿‡ä¸€èˆ¬ç”¨ä¸åˆ°ï¼Œå› æ­¤è¿™é‡Œæˆ‘ä»¬é…ç½® `defaultZone` é»˜è®¤åŒºåŸŸä¸º Eureka-Server åœ°å€ http://127.0.0.1:8761/eureka/ å³å¯ï¼Œå³æˆ‘ä»¬åœ¨ä¸Šä¸€å°èŠ‚æ­å»ºçš„ Eureka-Server çš„åœ°å€ã€‚

#### DemoProviderApplication

åˆ›å»º `DemoProviderApplication` ç±»ï¼Œåˆ›å»ºåº”ç”¨å¯åŠ¨ç±»ï¼Œå¹¶æä¾› HTTP æ¥å£ã€‚ä»£ç å¦‚ä¸‹ï¼š

```java
@SpringBootApplication
@EnableEurekaClient
public class DemoProviderApplication {

    public static void main(String[] args) {
        SpringApplication.run(Application.class);
    }

}
```

